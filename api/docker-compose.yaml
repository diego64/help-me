services:
  postgresql_helpme:
    image: bitnami/postgresql:latest
    container_name: postgresql_helpme
    hostname: postgresql_helpme

    environment:
      # Autenticação
      POSTGRESQL_USERNAME: ${DB_USER}
      POSTGRESQL_PASSWORD: ${DB_PASSWORD}
      POSTGRESQL_DATABASE: ${DB_NAME}

      # Configurações Regionais
      POSTGRESQL_TIMEZONE: America/Sao_Paulo
      TZ: America/Sao_Paulo

      # Segurança
      POSTGRESQL_ENABLE_LDAP: "no"
      POSTGRESQL_ENABLE_TLS: "no"
      POSTGRESQL_PASSWORD_ENCRYPTION: scram-sha-256

      # Performance & Otimizações
      POSTGRESQL_SHARED_PRELOAD_LIBRARIES: pg_stat_statements
      POSTGRESQL_MAX_CONNECTIONS: ${DB_MAX_CONNECTIONS:-100}

    ports:
      - "${DB_PORT:-5432}:5432"

    volumes:
      - postgresql_data:/bitnami/postgresql
      - postgresql_backups:/backups
      - postgresql_archive:/bitnami/postgresql/archive

    networks:
      - helpme_network

    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "PGPASSWORD=${DB_PASSWORD} pg_isready -U ${DB_USER} -d ${DB_NAME} && PGPASSWORD=${DB_PASSWORD} psql -U ${DB_USER} -d ${DB_NAME} -c 'SELECT 1' > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  mongodb_helpme:
    image: mongo:latest
    container_name: mongodb_helpme
    hostname: mongodb_helpme

    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE}

    healthcheck:
      test: |
        mongosh --quiet --username $${MONGO_INITDB_ROOT_USERNAME} \
          --password $${MONGO_INITDB_ROOT_PASSWORD} \
          --authenticationDatabase admin \
          --eval "db.adminCommand('ping')" > /dev/null
      interval: 10s
      timeout: 5s
      start_period: 20s
      retries: 5

    ports:
      - "${MONGO_PORT:-27017}:27017"

    volumes:
      - mongodb_data:/data/db

    networks:
      - helpme_network

    restart: unless-stopped

networks:
  helpme_network:
    driver: bridge
    name: helpme_network

volumes:
  postgresql_data:
    driver: local
    name: postgresql_helpme_data
  postgresql_backups:
    driver: local
    name: postgresql_helpme_backups
  postgresql_archive:
    driver: local
    name: postgresql_helpme_archive
  mongodb_data:
    driver: local
    name: mongodb_helpme_data
