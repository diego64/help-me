services:
  # ============================================
  # BANCO DE DADOS - PostgreSQL
  # ============================================
  postgresql_helpme:
    image: bitnami/postgresql:latest
    container_name: postgresql_helpme
    hostname: postgresql_helpme
    environment:
      POSTGRESQL_USERNAME: ${DB_USER}
      POSTGRESQL_PASSWORD: ${DB_PASSWORD}
      POSTGRESQL_DATABASE: ${DB_NAME}
      POSTGRESQL_TIMEZONE: America/Sao_Paulo
      TZ: America/Sao_Paulo
      POSTGRESQL_ENABLE_LDAP: "no"
      POSTGRESQL_ENABLE_TLS: "no"
      POSTGRESQL_PASSWORD_ENCRYPTION: scram-sha-256
      POSTGRESQL_SHARED_PRELOAD_LIBRARIES: pg_stat_statements
      POSTGRESQL_MAX_CONNECTIONS: ${DB_MAX_CONNECTIONS:-20}
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgresql_data:/bitnami/postgresql
      - ./api/database/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
      - postgresql_backups:/backups
      - postgresql_archive:/bitnami/postgresql/archive
    networks:
      - helpme_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "PGPASSWORD=${DB_PASSWORD} pg_isready -U ${DB_USER} -d ${DB_NAME} && PGPASSWORD=${DB_PASSWORD} psql -U ${DB_USER} -d ${DB_NAME} -c 'SELECT 1' > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  postgresql_helpme_teste:
    image: bitnami/postgresql:latest
    container_name: postgresql_helpme_teste
    hostname: postgresql_helpme_teste
    environment:
      POSTGRESQL_USERNAME: teste
      POSTGRESQL_PASSWORD: senha
      POSTGRESQL_DATABASE: helpme-database-teste
    ports:
      - "5433:5432"
    networks:
      - helpme_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U teste"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ============================================
  # BANCO DE DADOS - MongoDB
  # ============================================
  mongodb_helpme:
    image: mongo:latest
    container_name: mongodb_helpme
    hostname: mongodb_helpme
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE}
    healthcheck:
      test: |
        mongosh --quiet --username $${MONGO_INITDB_ROOT_USERNAME} \
          --password $${MONGO_INITDB_ROOT_PASSWORD} \
          --authenticationDatabase admin \
          --eval "db.adminCommand('ping')" > /dev/null
      interval: 10s
      timeout: 5s
      start_period: 20s
      retries: 5
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
      - ./api/database/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js
    networks:
      - helpme_network
    restart: unless-stopped

  mongo-test:
    image: mongo:latest
    container_name: mongodb_helpme_teste
    hostname: mongodb_helpme_teste
    environment:
      MONGO_INITDB_ROOT_USERNAME: teste
      MONGO_INITDB_ROOT_PASSWORD: senha
      MONGO_INITDB_DATABASE: helpme-mongo-teste
    ports:
      - "27018:27017"
    networks:
      - helpme_network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 5s
      timeout: 5s
      retries: 5

  # ============================================
  # MESSAGE BROKER - Kafka
  # ============================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper_helpme
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - '2181:2181'
    networks:
      - helpme_network
    restart: unless-stopped

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka_helpme
    depends_on:
      - zookeeper
    ports:
      - '9092:9092'
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
    healthcheck:
      test: ["CMD-SHELL", "echo > /dev/tcp/localhost/9092"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    networks:
      - helpme_network
    restart: unless-stopped

  control-center:
    image: confluentinc/cp-enterprise-control-center:7.5.0
    container_name: control-center_helpme
    depends_on:
      kafka:
        condition: service_healthy
      zookeeper:
        condition: service_started
    ports:
      - '9021:9021'
    environment:
      CONTROL_CENTER_BOOTSTRAP_SERVERS: 'localhost:9092'
      CONTROL_CENTER_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      CONTROL_CENTER_REPLICATION_FACTOR: 1
      PORT: 9021
    networks:
      - helpme_network
    restart: unless-stopped

  # ============================================
  # CACHE - Redis
  # ============================================
  redis_helpme:
    image: redis:latest
    container_name: redis_helpme
    hostname: redis_helpme
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - helpme_network
    restart: unless-stopped

  # ============================================
  # MONITORAMENTO K6 - InfluxDB
  # ============================================
  influxdb_k6:
    image: influxdb:2.7-alpine
    container_name: influxdb_k6_helpme
    hostname: influxdb_k6
    restart: unless-stopped
    
    ports:
      - "8086:8086"
    
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin123456
      - DOCKER_INFLUXDB_INIT_ORG=k6-org
      - DOCKER_INFLUXDB_INIT_BUCKET=k6
      - DOCKER_INFLUXDB_INIT_RETENTION=30d
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=my-super-secret-auth-token
    
    volumes:
      - influxdb_k6_data:/var/lib/influxdb2
      - influxdb_k6_config:/etc/influxdb2
    
    networks:
      - helpme_network
    
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # MONITORAMENTO K6 - Grafana
  # ============================================
  grafana_k6:
    image: grafana/grafana:10.2.3
    container_name: grafana_k6_helpme
    hostname: grafana_k6
    restart: unless-stopped
    
    ports:
      - "3001:3000"
    
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_BASIC_ENABLED=false
      - GF_SERVER_ROOT_URL=http://localhost:3001
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    
    volumes:
      - grafana_k6_data:/var/lib/grafana
      - ./dash/grafana/provisioning:/etc/grafana/provisioning
      - ./dash/grafana/dashboards:/var/lib/grafana/dashboards
    
    networks:
      - helpme_network
    
    depends_on:
      influxdb_k6:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # MONITORAMENTO K6 - Prometheus
  # ============================================
  prometheus_k6:
    image: prom/prometheus:v2.48.1
    container_name: prometheus_k6_helpme
    hostname: prometheus_k6
    restart: unless-stopped
    
    ports:
      - "9090:9090"
    
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    
    volumes:
      - ./dash/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_k6_data:/prometheus
    
    networks:
      - helpme_network

# ============================================
# NETWORKS
# ============================================
networks:
  helpme_network:
    driver: bridge
    name: helpme_network

# ============================================
# VOLUMES
# ============================================
volumes:
  # PostgreSQL
  postgresql_data:
    driver: local
    name: postgresql_helpme_data
  postgresql_backups:
    driver: local
    name: postgresql_helpme_backups
  postgresql_archive:
    driver: local
    name: postgresql_helpme_archive
  
  # MongoDB
  mongodb_data:
    driver: local
    name: mongodb_helpme_data
  
  # Redis
  redis_data:
    driver: local
    name: redis_helpme_data
  
  # K6 Monitoring
  influxdb_k6_data:
    driver: local
    name: influxdb_k6_helpme_data
  influxdb_k6_config:
    driver: local
    name: influxdb_k6_helpme_config
  grafana_k6_data:
    driver: local
    name: grafana_k6_helpme_data
  prometheus_k6_data:
    driver: local
    name: prometheus_k6_helpme_data