services:
  # ============================================
  # BANCO DE DADOS - PostgreSQL
  # ============================================
  postgresql_helpme:
    image: postgres:16
    container_name: postgresql_helpme
    hostname: postgresql_helpme
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
      TZ: America/Sao_Paulo
      PGTZ: America/Sao_Paulo
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgresql_data:/var/lib/postgresql/data
      - ./api/database/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
      - postgresql_backups:/backups
      - postgresql_archive:/archive
    networks:
      - helpme_network
    restart: unless-stopped
    command:
      - "postgres"
      - "-c"
      - "max_connections=${DB_MAX_CONNECTIONS:-100}"
      - "-c"
      - "shared_buffers=${DB_SHARED_BUFFERS:-256MB}"
      - "-c"
      - "effective_cache_size=${DB_EFFECTIVE_CACHE_SIZE:-1GB}"
      - "-c"
      - "work_mem=${POSTGRESQL_WORK_MEM:-16MB}"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"
      - "-c"
      - "password_encryption=scram-sha-256"
      - "-c"
      - "shared_preload_libraries=pg_stat_statements"
      - "-c"
      - "log_timezone=America/Sao_Paulo"
      - "-c"
      - "timezone=America/Sao_Paulo"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=database"
      - "com.helpme.database.type=postgresql"
      - "com.helpme.environment=production"

  # ============================================
  # BANCO DE DADOS - PostgreSQL (Teste)
  # ============================================
  postgresql_helpme_teste:
    image: postgres:16
    container_name: postgresql_helpme_teste
    hostname: postgresql_helpme_teste
    environment:
      POSTGRES_USER: ${DB_USER_TESTE:-teste}
      POSTGRES_PASSWORD: ${DB_PASSWORD_TESTE:-senha_teste}
      POSTGRES_DB: ${DB_NAME_TESTE:-helpme-database-teste}
      TZ: America/Sao_Paulo
      PGTZ: America/Sao_Paulo
    ports:
      - "${DB_PORT_TESTE:-5433}:5432"
    volumes:
      - postgresql_data_teste:/var/lib/postgresql/data
    networks:
      - helpme_network
    restart: unless-stopped
    command:
      - "postgres"
      - "-c"
      - "max_connections=50"
      - "-c"
      - "shared_buffers=128MB"
      - "-c"
      - "effective_cache_size=512MB"
      - "-c"
      - "work_mem=8MB"
      - "-c"
      - "timezone=America/Sao_Paulo"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER_TESTE:-teste} -d ${DB_NAME_TESTE:-helpme-database-teste}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=database"
      - "com.helpme.database.type=postgresql"
      - "com.helpme.environment=test"

  # ============================================
  # BANCO DE DADOS - MongoDB
  # ============================================
  mongodb_helpme:
    image: mongo:8.0
    container_name: mongodb_helpme
    hostname: mongodb_helpme
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE}
      TZ: America/Sao_Paulo
    command: mongod --bind_ip_all --auth
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
      - ./api/database/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js
    networks:
      - helpme_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: |
        mongosh --quiet --username ${MONGO_INITDB_ROOT_USERNAME} \
          --password ${MONGO_INITDB_ROOT_PASSWORD} \
          --authenticationDatabase admin \
          --eval "db.adminCommand('ping')" > /dev/null
      interval: 15s
      timeout: 10s
      start_period: 40s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=database"
      - "com.helpme.database.type=mongodb"
      - "com.helpme.environment=production"

  # ============================================
  # BANCO DE DADOS - MongoDB (Teste)
  # ============================================
  mongodb_helpme_teste:
    image: mongo:8.0
    container_name: mongodb_helpme_teste
    hostname: mongodb_helpme_teste
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME_TESTE}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD_TESTE}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE_TESTE}
      TZ: America/Sao_Paulo
    command: mongod --bind_ip_all --auth
    ports:
      - "${MONGO_PORT_TESTE:-27018}:27017"
    volumes:
      - mongodb_teste_data:/data/db
    networks:
      - helpme_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: |
        mongosh --quiet --username ${MONGO_INITDB_ROOT_USERNAME_TESTE:-teste} \
          --password ${MONGO_INITDB_ROOT_PASSWORD_TESTE:-senha_teste} \
          --authenticationDatabase admin \
          --eval "db.adminCommand('ping')" > /dev/null || exit 1
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=database"
      - "com.helpme.database.type=mongodb"
      - "com.helpme.environment=test"

  # ============================================
  # MESSAGE BROKER - Kafka
  # ============================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper_helpme
    environment:
      ZOOKEEPER_CLIENT_PORT: ${ZOOKEEPER_CLIENT_PORT:-2181}
      ZOOKEEPER_TICK_TIME: ${ZOOKEEPER_TICK_TIME:-2000}
      TZ: America/Sao_Paulo
    ports:
      - '${ZOOKEEPER_PORT:-2181}:2181'
    networks:
      - helpme_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=messaging"
      - "com.helpme.messaging.type=zookeeper"

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka_helpme
    depends_on:
      - zookeeper
    ports:
      - '9092:9092'
      - '9093:9093'
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_LOG_RETENTION_HOURS: 168
      TZ: America/Sao_Paulo
    networks:
      - helpme_network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=messaging"
      - "com.helpme.messaging.type=kafka"

  control-center:
    image: confluentinc/cp-enterprise-control-center:7.5.0
    container_name: control_center_helpme
    depends_on:
      - kafka
      - zookeeper
    ports:
      - '${CONTROL_CENTER_PORT:-9021}:9021'
    environment:
      CONTROL_CENTER_BOOTSTRAP_SERVERS: ${CONTROL_CENTER_BOOTSTRAP_SERVERS:-kafka:9092}
      CONTROL_CENTER_ZOOKEEPER_CONNECT: ${CONTROL_CENTER_ZOOKEEPER_CONNECT:-zookeeper:2181}
      CONTROL_CENTER_REPLICATION_FACTOR: ${CONTROL_CENTER_REPLICATION_FACTOR:-1}
      PORT: 9021
      TZ: America/Sao_Paulo
    networks:
      - helpme_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=messaging"
      - "com.helpme.messaging.type=control-center"

  # ============================================
  # CACHE - Redis
  # ============================================
  redis_helpme:
    image: redis:8.0
    container_name: redis_helpme
    hostname: redis_helpme
    environment:
      TZ: America/Sao_Paulo
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    command: >
      sh -c '
      if [ -z "$REDIS_PASSWORD" ]; then
        redis-server
        --maxmemory ${REDIS_MAX_MEMORY:-512mb}
        --maxmemory-policy ${REDIS_MAXMEMORY_POLICY:-allkeys-lru}
        --appendonly yes
        --appendfsync everysec
      else
        redis-server
        --requirepass "$REDIS_PASSWORD"
        --maxmemory ${REDIS_MAX_MEMORY:-512mb}
        --maxmemory-policy ${REDIS_MAXMEMORY_POLICY:-allkeys-lru}
        --appendonly yes
        --appendfsync everysec
      fi
      '
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - helpme_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=cache"
      - "com.helpme.cache.type=redis"

  # ============================================
  # MONITORAMENTO - InfluxDB
  # ============================================
  influxdb:
    image: influxdb:2.7-alpine
    container_name: influxdb_helpme
    hostname: influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USERNAME}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG:-org}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET}
      DOCKER_INFLUXDB_INIT_RETENTION: ${INFLUX_RETENTION}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_ADMIN_TOKEN}
      INFLUXDB_HTTP_LOG_ENABLED: ${INFLUX_HTTP_LOG_ENABLED:-true}
      TZ: America/Sao_Paulo
    ports:
      - "${INFLUX_PORT:-8086}:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    networks:
      - helpme_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=monitoring"
      - "com.helpme.monitoring.type=timeseries"

  # ============================================
  # MONITORAMENTO - Loki (Logs)
  # ============================================
  loki:
      image: grafana/loki:3.0.0
      container_name: helpme_loki
      hostname: loki
      environment:
        TZ: America/Sao_Paulo
      ports:
        - "${LOKI_PORT:-3100}:3100"
      command: -config.file=/etc/loki/local-config.yaml
      volumes:
        - ./monitoring/loki-config.yml:/etc/loki/local-config.yaml:ro
        - loki_data:/loki
      networks:
        - helpme_network
      restart: unless-stopped
      deploy:
        resources:
          limits:
            cpus: '1'
            memory: 1G
          reservations:
            cpus: '0.25'
            memory: 256M
      healthcheck:
        test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
        interval: 10s
        timeout: 5s
        retries: 5
        start_period: 10s
      logging:
        driver: "json-file"
        options:
          max-size: "10m"
          max-file: "3"
      labels:
        - "com.helpme.service=monitoring"
        - "com.helpme.monitoring.type=logs"

  # ============================================
  # MONITORAMENTO - Promtail (Log Collector)
  # ============================================
  promtail:
    image: grafana/promtail:3.0.0
    container_name: helpme_promtail
    hostname: promtail
    environment:
      TZ: America/Sao_Paulo
    volumes:
      - ./monitoring/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ~/code/node/help-me/api/logs:/host/logs:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      - helpme_network
    depends_on:
      loki:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=monitoring"
      - "com.helpme.monitoring.type=log-collector"

  # ============================================
  # MONITORAMENTO - Grafana
  # ============================================
  grafana:
    image: grafana/grafana:10.2.3
    container_name: grafana_helpme
    hostname: grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      GF_AUTH_BASIC_ENABLED: "true"
      GF_SERVER_ROOT_URL: http://localhost:${GRAFANA_PORT:-3001}
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
      GF_INSTALL_PLUGINS: grafana-mongodb-datasource,redis-datasource
      GF_METRICS_ENABLED: ${GRAFANA_METRICS_ENABLED:-true}
      TZ: America/Sao_Paulo
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      # Datasources e dashboards existentes (da pasta dashboards/)
      - ./dashboards/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./dashboards/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./dashboards/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - helpme_network
    depends_on:
      - influxdb
      - postgresql_helpme
      - loki
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=monitoring"
      - "com.helpme.monitoring.type=visualization"

  # ============================================
  # MONITORAMENTO - Prometheus
  # ============================================
  prometheus:
    image: prom/prometheus:v2.48.1
    container_name: prometheus_helpme
    hostname: prometheus
    environment:
      TZ: America/Sao_Paulo
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-15d}'
      - '--web.enable-lifecycle'
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./dash/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - helpme_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9090/-/healthy || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=monitoring"
      - "com.helpme.monitoring.type=metrics"

  # ============================================
  # MONITORAMENTO - Node Exporter
  # ============================================
  node-exporter:
    image: prom/node-exporter:v1.7.0
    container_name: node_exporter_helpme
    hostname: node-exporter
    environment:
      TZ: America/Sao_Paulo
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    ports:
      - "${NODE_EXPORTER_PORT:-9100}:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - helpme_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=monitoring"
      - "com.helpme.monitoring.type=exporter"
      - "com.helpme.exporter.target=node"

  # ============================================
  # MONITORAMENTO - cAdvisor
  # ============================================
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    container_name: cadvisor_helpme
    hostname: cadvisor
    privileged: true
    environment:
      TZ: America/Sao_Paulo
    ports:
      - "${CADVISOR_PORT:-8080}:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    command:
      - '--housekeeping_interval=30s'
      - '--docker_only=false'
      - '--store_container_labels=false'
    networks:
      - helpme_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=monitoring"
      - "com.helpme.monitoring.type=container-metrics"

  # ============================================
  # MONITORAMENTO - PostgreSQL Exporter
  # ============================================
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: postgres_exporter_helpme
    hostname: postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://${DB_USER}:${DB_PASSWORD}@postgresql_helpme:5432/${DB_NAME}?sslmode=disable"
      TZ: America/Sao_Paulo
    ports:
      - "${POSTGRES_EXPORTER_PORT:-9187}:9187"
    networks:
      - helpme_network
    restart: unless-stopped
    depends_on:
      postgresql_helpme:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=monitoring"
      - "com.helpme.monitoring.type=exporter"
      - "com.helpme.exporter.target=postgresql"

  # ============================================
  # MONITORAMENTO - MongoDB Exporter
  # ============================================
  mongodb-exporter:
    image: percona/mongodb_exporter:0.40
    container_name: mongodb_exporter_helpme
    hostname: mongodb-exporter
    environment:
      MONGODB_URI: "mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb_helpme:27017"
      TZ: America/Sao_Paulo
    ports:
      - "${MONGODB_EXPORTER_PORT:-9216}:9216"
    command:
      - '--mongodb.direct-connect=true'
      - '--mongodb.global-conn-pool=true'
      - '--collect-all'
    depends_on:
      mongodb_helpme:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    networks:
      - helpme_network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=monitoring"
      - "com.helpme.monitoring.type=exporter"
      - "com.helpme.exporter.target=mongodb"

  # ============================================
  # MONITORAMENTO - Redis Exporter
  # ============================================
  redis-exporter:
    image: oliver006/redis_exporter:v1.55.0
    container_name: redis_exporter_helpme
    hostname: redis-exporter
    environment:
      REDIS_ADDR: "redis://redis_helpme:6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_helpme_password}
      TZ: America/Sao_Paulo
    ports:
      - "${REDIS_EXPORTER_PORT:-9121}:9121"
    networks:
      - helpme_network
    restart: unless-stopped
    depends_on:
      - redis_helpme
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=monitoring"
      - "com.helpme.monitoring.type=exporter"
      - "com.helpme.exporter.target=redis"

  # ============================================
  # MONITORAMENTO - Kafka Exporter
  # ============================================
  kafka-exporter:
    image: danielqsj/kafka-exporter:v1.7.0
    container_name: kafka_exporter_helpme
    hostname: kafka-exporter
    environment:
      TZ: America/Sao_Paulo
    ports:
      - "${KAFKA_EXPORTER_PORT:-9308}:9308"
    command:
      - '--kafka.server=kafka:9092'
    networks:
      - helpme_network
    restart: unless-stopped
    depends_on:
      - kafka
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.helpme.service=monitoring"
      - "com.helpme.monitoring.type=exporter"
      - "com.helpme.exporter.target=kafka"

# ============================================
# NETWORKS
# ============================================
networks:
  helpme_network:
    driver: bridge
    name: helpme_network
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1

# ============================================
# VOLUMES
# ============================================
volumes:
  postgresql_data:
    driver: local
    name: postgresql_helpme_data
  postgresql_data_teste:
    driver: local
    name: postgresql_helpme_data_teste
  postgresql_backups:
    driver: local
    name: postgresql_helpme_backups
  postgresql_archive:
    driver: local
    name: postgresql_helpme_archive
  mongodb_data:
    driver: local
    name: mongodb_helpme_data
  mongodb_teste_data:
    driver: local
    name: mongodb_helpme_teste_data
  redis_data:
    driver: local
    name: redis_helpme_data
  influxdb_data:
    driver: local
    name: influxdb_helpme_data
  influxdb_config:
    driver: local
    name: influxdb_helpme_config
  loki_data:
    driver: local
    name: loki_helpme_data
  grafana_data:
    driver: local
    name: grafana_helpme_data
  prometheus_data:
    driver: local
    name: prometheus_helpme_data