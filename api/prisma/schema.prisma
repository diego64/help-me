generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum Regra {
  ADMIN
  TECNICO
  USUARIO
}

enum ChamadoStatus {
  ABERTO
  EM_ATENDIMENTO
  ENCERRADO
  CANCELADO
  REABERTO
}

enum Setor {
  ADMINISTRACAO
  ALMOXARIFADO
  CALL_CENTER
  COMERCIAL
  DEPARTAMENTO_PESSOAL
  FINANCEIRO
  JURIDICO
  LOGISTICA
  MARKETING
  QUALIDADE
  RECURSOS_HUMANOS
  TECNOLOGIA_INFORMACAO
}

// ==================== MODELS ====================

model Usuario {
  id                     String         @id @default(cuid())
  nome                   String
  sobrenome              String
  email                  String         @unique
  password               String
  regra                  Regra
  setor                  Setor?
  telefone               String?
  ramal                  String?
  avatarUrl              String?
  geradoEm               DateTime       @default(now())
  atualizadoEm           DateTime       @updatedAt
  ativo                  Boolean        @default(true)
  refreshToken           String?

  chamadoOS              Chamado[]      @relation("UsuarioChamado")
  tecnicoChamados        Chamado[]      @relation("TecnicoResponsavel")
  tecnicoDisponibilidade Expediente[]
  
// ==================== INDEX ====================

  @@index([regra])
  @@index([ativo])
  @@index([setor])
  @@map("usuarios")
}

model Expediente {
  id           String     @id @default(cuid())
  usuario      Usuario    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId    String
  entrada      String
  saida        String
  
  @@index([usuarioId])
  @@map("expedientes")
}

model Servico {
  id           String     @id @default(cuid())
  nome         String     @unique
  descricao    String?
  ativo        Boolean    @default(true)
  geradoEm     DateTime   @default(now())
  atualizadoEm DateTime   @updatedAt
  chamados     OrdemDeServico[]
  
  @@index([ativo])
  @@map("servicos")
}

model Chamado {
  id                    String                @id @default(cuid())
  OS                    String                @unique
  descricao             String
  descricaoEncerramento String?
  status                ChamadoStatus         @default(ABERTO)
  geradoEm              DateTime              @default(now())
  atualizadoEm          DateTime              @updatedAt
  encerradoEm           DateTime?

  usuario               Usuario               @relation("UsuarioChamado", fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId             String

  tecnico               Usuario?              @relation("TecnicoResponsavel", fields: [tecnicoId], references: [id], onDelete: SetNull)
  tecnicoId             String?

  servicos              OrdemDeServico[]
  
  @@index([usuarioId])
  @@index([tecnicoId])
  @@index([status])
  @@index([geradoEm])
  @@map("chamados")
}

model OrdemDeServico {
  id         String    @id @default(cuid())
  chamado    Chamado   @relation(fields: [chamadoId], references: [id], onDelete: Cascade)
  chamadoId  String
  servico    Servico   @relation(fields: [servicoId], references: [id], onDelete: Cascade)
  servicoId  String

// ==================== PREVENÇÃO DE DUPLICIDADE DE DADOS ====================

  @@unique([chamadoId, servicoId])
  @@index([chamadoId])
  @@index([servicoId])
  @@map("ordens_de_servico")
}