generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum Regra {
  ADMIN
  TECNICO
  USUARIO
}

enum ChamadoStatus {
  ABERTO
  EM_ATENDIMENTO
  ENCERRADO
  CANCELADO
  REABERTO
}

enum Setor {
  ADMINISTRACAO
  ALMOXARIFADO
  CALL_CENTER
  COMERCIAL
  DEPARTAMENTO_PESSOAL
  FINANCEIRO
  JURIDICO
  LOGISTICA
  MARKETING
  QUALIDADE
  RECURSOS_HUMANOS
  TECNOLOGIA_INFORMACAO
}

// ==================== MODELS ====================

model Usuario {
  id                     String      @id @default(cuid())
  nome                   String      @db.VarChar(100)
  sobrenome              String      @db.VarChar(100)
  email                  String      @unique @db.VarChar(255)
  password               String      @db.VarChar(512)
  regra                  Regra
  setor                  Setor?
  telefone               String?
  ramal                  String?
  avatarUrl              String?

  geradoEm               DateTime    @default(now()) @map("gerado_em") @db.Timestamptz(3)
  atualizadoEm           DateTime    @updatedAt @map("atualizado_em") @db.Timestamptz(3)
  deletadoEm             DateTime?   @map("deletado_em") @db.Timestamptz(3)
  ativo                  Boolean     @default(true)
  refreshToken           String?

  chamadoOS              Chamado[]   @relation("UsuarioChamado")
  tecnicoChamados        Chamado[]   @relation("TecnicoResponsavel")
  tecnicoDisponibilidade Expediente[]

  // ==================== INDEX ====================

  @@index([email])
  @@index([regra])
  @@index([ativo])
  @@index([setor])
  @@index([deletadoEm])
  @@map("usuarios")
}

model Expediente {
  id           String   @id @default(cuid())
  usuario      Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId    String
  entrada      DateTime @db.Timestamptz(3)
  saida        DateTime @db.Timestamptz(3)

  geradoEm     DateTime  @default(now()) @map("gerado_em") @db.Timestamptz(3)
  atualizadoEm DateTime  @updatedAt @map("atualizado_em") @db.Timestamptz(3)
  deletadoEm   DateTime? @map("deletado_em") @db.Timestamptz(3)
  ativo        Boolean   @default(true)

  @@index([usuarioId])
  @@map("expedientes")
}

model Servico {
  id           String   @id @default(cuid())
  nome         String   @unique
  descricao    String?

  geradoEm     DateTime  @default(now()) @map("gerado_em") @db.Timestamptz(3)
  atualizadoEm DateTime  @updatedAt @map("atualizado_em") @db.Timestamptz(3)
  deletadoEm   DateTime? @map("deletado_em") @db.Timestamptz(3)
  ativo        Boolean   @default(true)

  chamados     OrdemDeServico[]

  @@index([nome])
  @@index([ativo])
  @@index([deletadoEm])
  @@map("servicos")
}

model Chamado {
  id                    String         @id @default(cuid())
  OS                    String         @unique @db.VarChar(50)
  descricao             String         @db.Text
  status                ChamadoStatus  @default(ABERTO)
  descricaoEncerramento String?        @map("descricao_encerramento") @db.Text

  geradoEm     DateTime  @default(now()) @map("gerado_em") @db.Timestamptz(3)
  atualizadoEm DateTime  @updatedAt @map("atualizado_em") @db.Timestamptz(3)
  encerradoEm  DateTime? @map("encerrado_em") @db.Timestamptz(3)
  deletadoEm   DateTime? @map("deletado_em") @db.Timestamptz(3)

  usuario      Usuario  @relation("UsuarioChamado", fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId    String   @map("usuario_id")

  tecnico      Usuario? @relation("TecnicoResponsavel", fields: [tecnicoId], references: [id], onDelete: SetNull)
  tecnicoId    String?  @map("tecnico_id")

  servicos     OrdemDeServico[]

  @@index([usuarioId])
  @@index([tecnicoId])
  @@index([status])
  @@index([geradoEm])
  @@index([OS])
  @@index([deletadoEm])
  @@index([status, geradoEm])
  @@index([tecnicoId, status])
  @@index([usuarioId, status])
  @@map("chamados")
}

model OrdemDeServico {
  id         String   @id @default(cuid())
  chamado    Chamado  @relation(fields: [chamadoId], references: [id], onDelete: Cascade)
  chamadoId  String   @map("chamado_id")

  servico    Servico  @relation(fields: [servicoId], references: [id], onDelete: Cascade)
  servicoId  String   @map("servico_id")

  geradoEm     DateTime  @default(now()) @map("gerado_em") @db.Timestamptz(3)
  atualizadoEm DateTime  @updatedAt @map("atualizado_em") @db.Timestamptz(3)
  deletadoEm   DateTime? @map("deletado_em") @db.Timestamptz(3)

  // ==================== PREVENÇÃO DE DUPLICIDADE DE DADOS ====================

  @@unique([chamadoId, servicoId], name: "unique_chamado_servico")
  @@index([chamadoId])
  @@index([servicoId])
  @@index([deletadoEm])
  @@map("ordens_de_servico")
}
