name: Pipeline CI/CD - HomologaÃ§Ã£o
run-name: Pipeline CI executado por ${{ github.actor }} (#${{ github.run_number }})

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o da release (ex: 1.0.0, 1.2.3)'
        required: false
        type: string
      create-tag:
        description: 'Criar tag Git com a versÃ£o?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  security-events: write

jobs:
  build:
    name: Build da AplicaÃ§Ã£o
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      
      - name: Ativar pnpm
        run: corepack enable
      
      - name: Instalar dependÃªncias
        working-directory: ./src
        run: pnpm install
      
      - name: Build do projeto
        working-directory: ./src
        run: pnpm build
      
      - name: Upload do build
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            ./src/dist
            ./src/node_modules
          retention-days: 1

  testes-unitarios:
    name: Testes UnitÃ¡rios
    needs: [build]
    runs-on: ubuntu-latest
    environment: homologacao
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      
      - name: Ativar pnpm
        run: corepack enable
      
      - name: Instalar dependÃªncias
        working-directory: ./src
        run: pnpm install
      
      - name: Executar testes unitÃ¡rios
        working-directory: ./src/__tests__/unit/
        run: pnpm test:unit

  testes-integracao:
    name: Testes de IntegraÃ§Ã£o
    needs: [build]
    runs-on: ubuntu-latest
    environment: homologacao
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: teste
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD_TEST }}
          POSTGRES_DB: helpme_database_teste
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      mongodb:
        image: mongo:7
        env:
          MONGO_INITDB_ROOT_USERNAME: teste
          MONGO_INITDB_ROOT_PASSWORD: ${{ secrets.MONGO_INITDB_ROOT_PASSWORD_TEST }}
        ports:
          - 27018:27017
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      
      - name: Ativar pnpm
        run: corepack enable
      
      - name: Instalar dependÃªncias
        working-directory: ./src
        run: pnpm install
      
      - name: Gerar .env de teste
        working-directory: ./src
        run: |
          cat > .env.test << EOF
          NODE_ENV=test
          DATABASE_URL=postgresql://teste:${{ secrets.DB_PASSWORD_TEST }}@localhost:5433/helpme_database_teste?schema=public
          MONGO_INITDB_URI=mongodb://teste:${{ secrets.MONGO_INITDB_ROOT_PASSWORD_TEST }}@localhost:27018/helpme_mongo_teste?authSource=admin
          JWT_SECRET=${{ secrets.JWT_SECRET_TEST }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET_TEST }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_TEST }}
          REDIS_HOST=localhost
          REDIS_PORT=6379
          SMTP_HOST=sandbox.smtp.mailtrap.io
          SMTP_PORT=2525
          SMTP_USER=${{ secrets.SMTP_USER_TEST }}
          SMTP_PASS=${{ secrets.SMTP_PASS_TEST }}
          API_BASE_URL=http://localhost:3000
          EOF
      
      - name: Executar migrations do Prisma
        working-directory: ./src
        run: pnpm prisma migrate deploy

  testes-e2e:
    name: Testes End-to-End
    needs: [build]
    runs-on: ubuntu-latest
    environment: homologacao
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      
      - name: Ativar pnpm
        run: corepack enable
      
      - name: Instalar dependÃªncias
        working-directory: ./src
        run: pnpm install
      
      - name: Gerar .env de teste E2E
        working-directory: ./src
        run: |
          cat > .env.test << EOF
          NODE_ENV=test
          DATABASE_URL=postgresql://teste:senha_teste@localhost:5433/helpme_database_teste?schema=public
          MONGO_INITDB_URI=mongodb://teste:senha@localhost:27018/helpme_mongo_teste?authSource=admin
          JWT_SECRET=${{ secrets.JWT_SECRET_TEST }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET_TEST }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD_TEST }}
          REDIS_HOST=localhost
          REDIS_PORT=6379
          KAFKA_BROKER_URL=localhost:9093
          INFLUX_ADMIN_TOKEN=${{ secrets.INFLUX_ADMIN_TOKEN }}
          INFLUX_PASSWORD=${{ secrets.INFLUX_PASSWORD }}
          SMTP_HOST=sandbox.smtp.mailtrap.io
          SMTP_PORT=2525
          SMTP_USER=${{ secrets.SMTP_USER_TEST }}
          SMTP_PASS=${{ secrets.SMTP_PASS_TEST }}
          API_BASE_URL=http://localhost:3000
          EOF
      
      - name: Subir infraestrutura completa com Docker Compose
        run: |
          docker compose -f docker-compose.test.yml up -d
          echo "Aguardando serviÃ§os..."
          sleep 30
          docker compose -f docker-compose.test.yml ps
      
      - name: Executar migrations
        working-directory: ./src
        run: pnpm prisma migrate deploy
      
      - name: Executar seed do banco (se necessÃ¡rio)
        working-directory: ./src
        run: pnpm prisma db seed || true
      
      - name: Executar testes E2E
        working-directory: ./src
        run: |
          pnpm test:setup
          pnpm exec dotenv -e .env.test -- pnpm vitest run src/__tests__/e2e
      
      - name: Logs dos serviÃ§os (se falhar)
        if: failure()
        run: |
          echo "=== PostgreSQL Logs ==="
          docker compose -f docker-compose.test.yml logs postgres
          echo "=== MongoDB Logs ==="
          docker compose -f docker-compose.test.yml logs mongodb
          echo "=== Kafka Logs ==="
          docker compose -f docker-compose.test.yml logs kafka
          echo "=== API Logs ==="
          docker compose -f docker-compose.test.yml logs api
      
      - name: Derrubar infraestrutura
        if: always()
        run: docker compose -f docker-compose.test.yml down -v

  release:
    name: Build e Push Docker Image
    runs-on: ubuntu-latest
    needs: [testes-unitarios, testes-integracao, testes-e2e]
    environment: homologacao
    outputs:
      version: ${{ steps.version.outputs.version }}
      tags: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determinar versÃ£o
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            # VersÃ£o fornecida manualmente
            VERSION="${{ inputs.version }}"
            echo "ðŸ“¦ VersÃ£o manual: $VERSION"
          else
            # Buscar Ãºltima tag ou usar padrÃ£o
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
            echo "ðŸ“¦ Ãšltima tag encontrada: $LAST_TAG"
            
            # Incrementar versÃ£o patch (0.0.0 -> 0.0.1)
            IFS='.' read -ra VERSION_PARTS <<< "${LAST_TAG#v}"
            MAJOR="${VERSION_PARTS[0]}"
            MINOR="${VERSION_PARTS[1]}"
            PATCH="${VERSION_PARTS[2]}"
            PATCH=$((PATCH + 1))
            VERSION="$MAJOR.$MINOR.$PATCH"
            echo "ðŸ“¦ Nova versÃ£o auto-incrementada: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      
      - name: Validar formato da versÃ£o
        run: |
          if ! [[ "${{ steps.version.outputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "VersÃ£o invÃ¡lida: ${{ steps.version.outputs.version }}"
            echo "Formato esperado: X.Y.Z (ex: 1.0.0, 2.3.4)"
            exit 1
          fi
          echo "VersÃ£o vÃ¡lida: ${{ steps.version.outputs.version }}"
      
      - name: Extrair metadados Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/helpme-api
          tags: |
            # VersÃ£o completa: 1.0.0
            type=raw,value=${{ steps.version.outputs.version }}
            # Major.Minor: 1.0
            type=raw,value={{major}}.{{minor}},enable=${{ steps.version.outputs.version != '' }}
            # Major: 1
            type=raw,value={{major}},enable=${{ steps.version.outputs.version != '' }}
            # Latest
            type=raw,value=latest
            # Homolog
            type=raw,value=homolog
            # SHA
            type=sha,prefix=sha-
            # Build number
            type=raw,value=build-${{ github.run_number }}
          flavor: |
            latest=auto
      
      - name: AnÃ¡lise do Dockerfile com Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
      
      - name: Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build e Push da imagem
        uses: docker/build-push-action@v6
        with:
          push: true
          context: .
          file: Dockerfile
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/helpme-api:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/helpme-api:buildcache,mode=max
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            GIT_COMMIT=${{ github.sha }}
      
      - name: Scan de vulnerabilidades com Trivy
        uses: aquasecurity/trivy-action@0.32.0
        with:
          scan-type: 'image'
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/helpme-api:${{ steps.version.outputs.version }}
          format: sarif
          output: trivy-results.sarif
          severity: "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL"
      
      - name: Upload resultados do Trivy
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          category: trivy-docker-scan
          sarif_file: trivy-results.sarif
      
      - name: Criar tag Git
        if: ${{ inputs.create-tag }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"
          echo "Tag v${{ steps.version.outputs.version }} criada e enviada"
      
      - name: Resumo da release
        run: |
          echo "## Release v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Imagens Docker Publicadas" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### VersÃ£o" >> $GITHUB_STEP_SUMMARY
          echo "- **VersÃ£o**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Para usar:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# VersÃ£o especÃ­fica" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ secrets.DOCKERHUB_USERNAME }}/helpme-api:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Ãšltima versÃ£o" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ secrets.DOCKERHUB_USERNAME }}/helpme-api:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.create-tag }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Tag Git criada" >> $GITHUB_STEP_SUMMARY
            echo "Tag **v${{ steps.version.outputs.version }}** foi criada no repositÃ³rio" >> $GITHUB_STEP_SUMMARY
          fi